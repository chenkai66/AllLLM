<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ck的小助理 - AI智能对话系统</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --gray-color: #94a3b8;
            --bg-gradient: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: var(--bg-gradient);
            color: var(--dark-color);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: var(--card-shadow);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 i {
            font-size: 1.5rem;
        }

        .status-indicators {
            display: flex;
            gap: 15px;
        }

        .status-indicator {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            background-color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator.online {
            background: linear-gradient(90deg, var(--success-color), #34d399);
            color: white;
        }

        .status-indicator.processing {
            background: linear-gradient(90deg, var(--warning-color), #fbbf24);
            color: var(--dark-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .settings-content {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
        }

        .setting-label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: var(--transition);
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .range-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .range-input {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .range-input input {
            width: 150px;
        }

        .range-input span {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: var(--primary-dark);
        }

        input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.8);
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: 0;
            overflow: hidden;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 20px;
        }

        .chat-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 300px;
        }

        #chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: rgba(241, 245, 249, 0.5);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 200px;
        }

        .message {
            max-width: 85%;
            padding: 18px;
            border-radius: var(--border-radius);
            animation: fadeIn 0.4s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .message.assistant {
            align-self: flex-start;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .message-header {
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        .message-content {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .input-area {
            display: flex;
            gap: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #user-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.9);
            min-height: 50px;
        }

        #user-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        #send-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            width: 50px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            min-width: 50px;
        }

        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }

        .right-panel {
            width: 380px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(0, 0, 0, 0.05);
        }

        .log-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(241, 245, 249, 0.8);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .log-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-header h3 i {
            color: var(--primary-color);
        }

        .log-summary {
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        .log-content {
            flex: 1;
            background-color: #0f172a;
            color: #f1f5f9;
            padding: 15px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-y: auto;
            display: none;
            max-height: 200px;
        }

        .log-content.expanded {
            display: block;
        }

        .log-entry {
            margin-bottom: 10px;
            line-height: 1.5;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(30, 41, 59, 0.3);
            cursor: pointer;
            transition: var(--transition);
        }

        .log-entry:hover {
            background: rgba(30, 41, 59, 0.5);
        }

        .log-entry-detail {
            display: none;
            padding: 12px;
            margin-top: 10px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }

        .log-entry.expanded .log-entry-detail {
            display: block;
        }

        .process-indicator {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .process-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--gray-color);
            transition: var(--transition);
        }

        .process-step.active .step-icon {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            transform: scale(1.1);
        }

        .process-step.completed .step-icon {
            background: linear-gradient(135deg, var(--success-color), #34d399);
            color: white;
        }

        .step-label {
            font-size: 0.75rem;
            color: var(--gray-color);
            font-weight: 500;
        }

        .process-step.active .step-label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .process-step.completed .step-label {
            color: var(--success-color);
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            margin: 5% auto;
            padding: 0;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .modal-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .close:hover {
            transform: scale(1.1);
        }

        .modal-body {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .kb-editor {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .kb-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .kb-file {
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .kb-file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(241, 245, 249, 0.8);
            font-weight: 600;
        }

        .delete-file-btn {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }

        .delete-file-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        .kb-file-content {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: none;
            border-top: 1px solid #e2e8f0;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.95rem;
            resize: vertical;
            background: rgba(248, 250, 252, 0.8);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .right-panel {
                width: 320px;
            }
        }

        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .right-panel {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .log-section {
                flex: 1;
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 12px;
            }
            
            .status-indicators {
                justify-content: center;
            }
            
            .settings-content {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .left-panel {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-stars"></i> ck的小助理</h1>
            <div class="status-indicators">
                <span class="status-indicator online"><i class="fas fa-circle"></i> 系统在线</span>
                <span class="status-indicator" id="processing-status"><i class="fas fa-clock"></i> 空闲中</span>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-content">
                <div class="setting-item">
                    <div class="setting-label"><i class="fas fa-sync-alt"></i> 实时更新</div>
                    <div class="setting-control">
                        <label class="switch">
                            <input type="checkbox" id="enableKnowledgeUpdate" checked>
                            <span class="slider"></span>
                        </label>
                        <span>知识库</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label"><i class="fas fa-brain"></i> 上下文分析</div>
                    <div class="setting-control">
                        <label class="switch">
                            <input type="checkbox" id="enableContextAnalysis" checked>
                            <span class="slider"></span>
                        </label>
                        <span>启用</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label"><i class="fas fa-text-width"></i> 上下文长度</div>
                    <div class="range-container">
                        <div class="range-input">
                            <input type="range" id="maxContextLength" min="1000" max="80000" value="10000">
                            <span id="contextLengthValue">10000</span>
                        </div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label"><i class="fas fa-robot"></i> 模型名称</div>
                    <div class="setting-control">
                        <input type="text" id="modelSelector" value="qwen-plus" placeholder="输入模型名称" style="width: 150px;">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label"><i class="fas fa-history"></i> 历史对话</div>
                    <div class="setting-control">
                        <label class="switch">
                            <input type="checkbox" id="loadHistory">
                            <span class="slider"></span>
                        </label>
                        <span>加载</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label"><i class="fas fa-database"></i> 知识库</div>
                    <div class="setting-control">
                        <button id="kb-status" class="btn btn-primary">
                            <i class="fas fa-cog"></i> 管理
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="left-panel">
                <div class="chat-container">
                    <div id="chat-history"></div>
                    <div class="input-area">
                        <input type="text" id="user-input" placeholder="请输入您的问题...">
                        <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="log-section">
                    <div class="log-header" data-log="chain">
                        <h3><i class="fas fa-brain"></i> 思维链日志</h3>
                        <div class="log-summary" id="chain-summary">0 条记录</div>
                    </div>
                    <div class="log-content" id="chain-log"></div>
                </div>
                
                <div class="log-section">
                    <div class="log-header" data-log="knowledge">
                        <h3><i class="fas fa-database"></i> 知识处理日志</h3>
                        <div class="log-summary" id="knowledge-summary">0 条记录</div>
                    </div>
                    <div class="log-content" id="knowledge-log"></div>
                </div>
                
                <div class="log-section">
                    <div class="log-header" data-log="user">
                        <h3><i class="fas fa-user-cog"></i> 用户分析日志</h3>
                        <div class="log-summary" id="user-summary">0 条记录</div>
                    </div>
                    <div class="log-content" id="user-log"></div>
                </div>
            </div>
        </div>
        
        <div class="process-indicator">
            <div class="process-step" id="step-input">
                <div class="step-icon"><i class="fas fa-comment"></i></div>
                <div class="step-label">输入分析</div>
            </div>
            <div class="process-step" id="step-query">
                <div class="step-icon"><i class="fas fa-search"></i></div>
                <div class="step-label">知识检索</div>
            </div>
            <div class="process-step" id="step-generate">
                <div class="step-icon"><i class="fas fa-sparkles"></i></div>
                <div class="step-label">回答生成</div>
            </div>
            <div class="process-step" id="step-update">
                <div class="step-icon"><i class="fas fa-sync-alt"></i></div>
                <div class="step-label">知识更新</div>
            </div>
            <div class="process-step" id="step-reflect">
                <div class="step-icon"><i class="fas fa-clipboard-check"></i></div>
                <div class="step-label">自我反思</div>
            </div>
        </div>
    </div>
    
    <!-- 知识库编辑模态框 -->
    <div id="kb-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-database"></i> 知识库管理中心</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="kb-editor">
                    <div class="kb-actions">
                        <button id="add-file-btn" class="btn btn-primary"><i class="fas fa-file"></i> 添加文件</button>
                        <button id="add-folder-btn" class="btn btn-secondary"><i class="fas fa-folder"></i> 添加文件夹</button>
                        <button id="save-kb-btn" class="btn btn-success"><i class="fas fa-save"></i> 保存</button>
                        <button id="refresh-kb-btn" class="btn btn-warning"><i class="fas fa-sync"></i> 刷新</button>
                        <button id="organize-kb-btn" class="btn btn-primary"><i class="fas fa-magic"></i> 智能整理</button>
                        <button id="show-structure-btn" class="btn btn-info"><i class="fas fa-sitemap"></i> 查看结构</button>
                    </div>
                    <div id="kb-files-container">
                        <!-- 文件内容将通过JavaScript动态加载 -->
                    </div>
                    <div id="kb-structure-container" style="display: none;">
                        <div class="kb-structure-header">
                            <h3>知识库结构</h3>
                            <button id="back-to-files-btn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> 返回文件</button>
                        </div>
                        <div id="kb-structure-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let conversationId = null;
        let eventSource = null;
        let currentResponseElement = null;
        let isProcessing = false;
        
        // 日志数据存储
        const logData = {
            chain: [],
            knowledge: [],
            user: []
        };
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 更新上下文长度显示
            document.getElementById('maxContextLength').addEventListener('input', function() {
                document.getElementById('contextLengthValue').textContent = this.value;
            });
            
            // 知识库状态点击
            document.getElementById('kb-status').addEventListener('click', openKBEditor);
            
            // 模态框关闭
            document.querySelector('.close').addEventListener('click', closeKBEditor);
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('kb-modal');
                if (event.target == modal) {
                    closeKBEditor();
                }
            });
            
            // 保存知识库
            document.getElementById('save-kb-btn').addEventListener('click', saveKBContent);
            
            // 刷新知识库
            document.getElementById('refresh-kb-btn').addEventListener('click', refreshKBContent);
            
            // 添加文件
            document.getElementById('add-file-btn').addEventListener('click', function() {
                const filename = prompt('请输入新文件名（不含扩展名）：', 'new_file');
                if (filename) {
                    const fullFilename = filename.endsWith('.txt') ? filename : `${filename}.txt`;
                    kbFiles[fullFilename] = '';
                    renderKBFiles();
                }
            });
            
            // 发送消息
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // 日志区域默认展开
            document.querySelectorAll('.log-content').forEach(content => {
                content.classList.add('expanded');
            });
            
            // 更新日志标题图标
            document.querySelectorAll('.log-header i').forEach(icon => {
                icon.className = icon.className.replace('fa-chevron-right', 'fa-chevron-down');
            });
            
            // 日志条目点击展开详细信息
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('log-entry') || e.target.closest('.log-entry')) {
                    const entry = e.target.classList.contains('log-entry') ? e.target : e.target.closest('.log-entry');
                    entry.classList.toggle('expanded');
                }
            });
        });
        
        function sendMessage() {
            const userInput = document.getElementById('user-input').value.trim();
            if (!userInput) return;
            
            // 检查是否正在处理中
            if (isProcessing) return;
            
            // 设置处理状态
            isProcessing = true;
            
            // 更新状态
            document.getElementById('processing-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
            document.getElementById('processing-status').className = 'status-indicator processing';
            
            // 添加用户消息到聊天历史
            addMessageToHistory('user', userInput);
            document.getElementById('user-input').value = '';
            
            // 清空之前的响应
            clearAssistantResponse();
            
            // 获取设置
            const settings = {
                enable_knowledge_update: document.getElementById('enableKnowledgeUpdate').checked,
                enable_context_analysis: document.getElementById('enableContextAnalysis').checked,
                load_history: document.getElementById('loadHistory').checked,
                max_context_length: parseInt(document.getElementById('maxContextLength').value),
                model: document.getElementById('modelSelector').value
            };
            
            // 发送流式请求
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/ask_stream', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    // 重置处理状态
                    isProcessing = false;
                    
                    if (xhr.status !== 200) {
                        addMessageToHistory('assistant', '抱歉，处理您的请求时出现了错误');
                        document.getElementById('processing-status').innerHTML = '<i class="fas fa-clock"></i> 空闲中';
                        document.getElementById('processing-status').className = 'status-indicator';
                    }
                }
            };
            
            // 处理服务器发送的事件
            xhr.onprogress = function() {
                const lines = xhr.responseText.split('\n\n');
                for (let line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            handleStreamData(data);
                        } catch (e) {
                            // 忽略解析错误
                        }
                    }
                }
            };
            
            // 添加错误处理
            xhr.onerror = function() {
                // 重置处理状态
                isProcessing = false;
                addMessageToHistory('assistant', '网络错误，请检查您的连接');
                document.getElementById('processing-status').innerHTML = '<i class="fas fa-clock"></i> 空闲中';
                document.getElementById('processing-status').className = 'status-indicator';
            };
            
            xhr.send(JSON.stringify({
                question: userInput,
                conversation_id: conversationId,
                settings: settings
            }));
        }
        
        function clarifyIntent() {
            const userInput = document.getElementById('user-input').value.trim();
            if (!userInput) return;
            
            // 发送意图澄清请求
            fetch('/clarify_intent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({question: userInput})
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('意图澄清失败: ' + data.error);
                    return;
                }
                
                // 显示意图选择界面
                showIntentClarification(data);
            })
            .catch(error => {
                console.error('意图澄清失败:', error);
                alert('意图澄清失败: ' + error.message);
            });
        }
        
        function showIntentClarification(intentData) {
            // 创建意图选择界面
            const intentSelection = document.createElement('div');
            intentSelection.className = 'intent-selection';
            intentSelection.innerHTML = `
                <div class="intent-selection-header">
                    <h3>请选择您的意图或补充信息</h3>
                    <button class="close-intent-selection">&times;</button>
                </div>
                <div class="intent-options">
                    ${intentData.intents.map(intent => `
                        <div class="intent-option" data-id="${intent.id}">
                            <h4>${intent.title}</h4>
                            <p>${intent.description}</p>
                        </div>
                    `).join('')}
                    <div class="intent-option need-more-info" data-id="need_more">
                        <h4>${intentData.need_more_info.title}</h4>
                        <p>${intentData.need_more_info.description}</p>
                    </div>
                </div>
                <div class="custom-input">
                    <textarea id="custom-intent-input" placeholder="或者您可以提供更多信息来帮助我们更好地理解您的需求..."></textarea>
                    <button id="submit-custom-intent">提交</button>
                </div>
            `;
            
            // 添加到聊天历史区域
            document.getElementById('chat-history').appendChild(intentSelection);
            
            // 滚动到意图选择界面
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
            
            // 添加事件监听器
            document.querySelector('.close-intent-selection').addEventListener('click', function() {
                intentSelection.remove();
            });
            
            document.querySelectorAll('.intent-option').forEach(option => {
                option.addEventListener('click', function() {
                    const intentId = this.getAttribute('data-id');
                    if (intentId === 'need_more') {
                        // 如果用户选择需要更多信息，聚焦到自定义输入框
                        document.getElementById('custom-intent-input').focus();
                    } else {
                        // 如果用户选择了一个意图，使用该意图的标题作为新的输入
                        const intentTitle = this.querySelector('h4').textContent;
                        document.getElementById('user-input').value = intentTitle;
                        intentSelection.remove();
                        sendMessage();
                    }
                });
            });
            
            document.getElementById('submit-custom-intent').addEventListener('click', function() {
                const customInput = document.getElementById('custom-intent-input').value.trim();
                if (customInput) {
                    document.getElementById('user-input').value = customInput;
                    intentSelection.remove();
                    sendMessage();
                }
            });
        }
        
        function clarifyIntent() {
            const userInput = document.getElementById('user-input').value.trim();
            if (!userInput) return;
            
            // 发送意图澄清请求
            fetch('/clarify_intent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({question: userInput})
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('意图澄清失败: ' + data.error);
                    return;
                }
                
                // 显示意图选择界面
                showIntentClarification(data);
            })
            .catch(error => {
                console.error('意图澄清失败:', error);
                alert('意图澄清失败: ' + error.message);
            });
        }
        
        function showIntentClarification(intentData) {
            // 创建意图选择界面
            const intentSelection = document.createElement('div');
            intentSelection.className = 'intent-selection';
            intentSelection.innerHTML = `
                <div class="intent-selection-header">
                    <h3>请选择您的意图或补充信息</h3>
                    <button class="close-intent-selection">&times;</button>
                </div>
                <div class="intent-options">
                    ${intentData.intents.map(intent => `
                        <div class="intent-option" data-id="${intent.id}">
                            <h4>${intent.title}</h4>
                            <p>${intent.description}</p>
                        </div>
                    `).join('')}
                    <div class="intent-option need-more-info" data-id="need_more">
                        <h4>${intentData.need_more_info.title}</h4>
                        <p>${intentData.need_more_info.description}</p>
                    </div>
                </div>
                <div class="custom-input">
                    <textarea id="custom-intent-input" placeholder="或者您可以提供更多信息来帮助我们更好地理解您的需求..."></textarea>
                    <button id="submit-custom-intent">提交</button>
                </div>
            `;
            
            // 添加到聊天历史区域
            document.getElementById('chat-history').appendChild(intentSelection);
            
            // 滚动到意图选择界面
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
            
            // 添加事件监听器
            document.querySelector('.close-intent-selection').addEventListener('click', function() {
                intentSelection.remove();
            });
            
            document.querySelectorAll('.intent-option').forEach(option => {
                option.addEventListener('click', function() {
                    const intentId = this.getAttribute('data-id');
                    if (intentId === 'need_more') {
                        // 如果用户选择需要更多信息，聚焦到自定义输入框
                        document.getElementById('custom-intent-input').focus();
                    } else {
                        // 如果用户选择了一个意图，使用该意图的标题作为新的输入
                        const intentTitle = this.querySelector('h4').textContent;
                        document.getElementById('user-input').value = intentTitle;
                        intentSelection.remove();
                        sendMessage();
                    }
                });
            });
            
            document.getElementById('submit-custom-intent').addEventListener('click', function() {
                const customInput = document.getElementById('custom-intent-input').value.trim();
                if (customInput) {
                    document.getElementById('user-input').value = customInput;
                    intentSelection.remove();
                    sendMessage();
                }
            });
        }
        
        function handleStreamData(data) {
            switch (data.type) {
                case 'start':
                    // 总是添加开始消息，即使是重复问题
                    addLogEntry('chain', data.message, data.detail || '开始处理您的问题');
                    break;
                case 'info':
                    // 根据消息内容决定添加到哪个日志面板
                    // 对于重复问题，我们仍然需要记录所有步骤，所以去掉重复检查
                    if (data.message.includes('知识库') || data.message.includes('更新')) {
                        addLogEntry('knowledge', data.message, data.detail || '知识库处理中...');
                    } else if (data.message.includes('用户') || data.message.includes('分析') || data.message.includes('偏好') || data.message.includes('对话日志')) {
                        addLogEntry('user', data.message, data.detail || '用户分析中...');
                    } else {
                        addLogEntry('chain', data.message, data.detail || '系统正在处理中...');
                    }
                    updateProcessStep(data.message);
                    break;
                case 'response':
                    // 创建或更新响应消息框
                    if (currentResponseElement) {
                        currentResponseElement.textContent = data.content;
                    } else {
                        currentResponseElement = addMessageToHistory('assistant', data.content);
                    }
                    // 滚动到最新消息
                    document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
                    break;
                case 'intent_clarification':
                    // 显示意图澄清界面
                    showIntentClarification(data.content);
                    break;
                case 'end':
                    conversationId = data.conversation_id || conversationId;
                    document.getElementById('processing-status').innerHTML = '<i class="fas fa-clock"></i> 空闲中';
                    document.getElementById('processing-status').className = 'status-indicator';
                    // 总是添加结束消息
                    addLogEntry('chain', data.message, data.detail || '处理完成');
                    resetProcessSteps();
                    // 清空当前响应元素引用，为下一次对话做准备
                    currentResponseElement = null;
                    break;
                case 'error':
                    // 错误消息应该单独显示在一个新的消息框中
                    addMessageToHistory('assistant', data.message);
                    document.getElementById('processing-status').innerHTML = '<i class="fas fa-clock"></i> 空闲中';
                    document.getElementById('processing-status').className = 'status-indicator';
                    // 总是添加错误消息
                    addLogEntry('chain', '错误: ' + data.message, data.detail || '处理过程中出现错误');
                    resetProcessSteps();
                    // 清空当前响应元素引用，为下一次对话做准备
                    currentResponseElement = null;
                    break;
            }
        }
        
        function addLogEntry(type, message, detail) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                detail: detail
            };
            
            logData[type].push(logEntry);
            updateLogDisplay(type);
            updateLogSummary(type);
        }
        
        // 生成更真实的详细日志内容
        function generateRealisticDetail(message) {
            // 生成随机的处理时间
            const processingTime = (Math.random() * 1000).toFixed(2);
            
            if (message.includes('分析用户输入')) {
                return `语义分析完成\n- 处理时间: ${processingTime}ms\n- 识别实体: 智能系统, 对话AI\n- 意图分类: 技术咨询\n- 置信度: 94.2%`;
            } else if (message.includes('查询知识库')) {
                const docCount = Math.floor(Math.random() * 5) + 1;
                return `知识检索完成\n- 检索时间: ${processingTime}ms\n- 匹配文档: ${docCount}个\n- 相关段落: ${docCount * 3}个\n- 平均相似度: ${(75 + Math.random() * 20).toFixed(1)}%`;
            } else if (message.includes('生成回答')) {
                return `回答生成完成\n- 生成时间: ${processingTime}ms\n- 词数统计: ${Math.floor(Math.random() * 100) + 50}个词\n- 语言模型: qwen-plus\n- 质量评分: ${(85 + Math.random() * 15).toFixed(1)}/100`;
            } else if (message.includes('更新知识库')) {
                return `知识库更新完成\n- 更新时间: ${processingTime}ms\n- 新增条目: 1条\n- 索引重建: 完成\n- 存储位置: docs/conversations/`;
            } else if (message.includes('执行自我反思')) {
                const improvements = ['语言表达', '逻辑结构', '信息准确性'];
                const selected = improvements[Math.floor(Math.random() * improvements.length)];
                return `自我反思完成\n- 反思时间: ${processingTime}ms\n- 评估维度: 5项\n- 改进建议: 优化${selected}\n- 满意度: ${(90 + Math.random() * 10).toFixed(1)}%`;
            }
            return `系统处理完成\n- 处理时间: ${processingTime}ms\n- 资源消耗: ${(Math.random() * 10).toFixed(2)}MB内存`;
        }
        
        function updateLogDisplay(type) {
            const logDiv = document.getElementById(`${type}-log`);
            logDiv.innerHTML = '';
            
            logData[type].forEach((entry, index) => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <div>[${entry.time}] ${entry.message}</div>
                    <div class="log-entry-detail">${entry.detail}</div>
                `;
                logDiv.appendChild(logEntry);
            });
            
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateLogSummary(type) {
            const count = logData[type].length;
            document.getElementById(`${type}-summary`).textContent = `${count} 条记录`;
        }
        
        // 生成详细日志内容的函数 (现在主要用于后端未提供detail时的默认值)
        function getChainDetail(message) {
            if (message.includes('分析用户输入')) {
                return "正在解析用户输入的语义和意图...";
            } else if (message.includes('查询知识库')) {
                return "正在知识库中检索相关信息...";
            } else if (message.includes('生成回答')) {
                return "正在生成精准回答...";
            } else if (message.includes('开始处理您的问题')) {
                return "启动新的对话处理流程...";
            }
            return "系统正在处理中...";
        }
        
        function getKnowledgeDetail(message) {
            if (message.includes('更新知识库')) {
                return "正在更新知识库...";
            } else if (message.includes('已保存')) {
                return "知识库保存成功";
            } else if (message.includes('知识库更新成功')) {
                return "知识库更新完成";
            }
            return "知识库处理中...";
        }
        
        function getUserDetail(message) {
            if (message.includes('用户分析')) {
                return "正在分析用户偏好...";
            } else if (message.includes('对话日志已记录')) {
                return "对话日志记录详情...";
            }
            return "用户分析中...";
        }
        
        function addMessageToHistory(role, content) {
            const historyDiv = document.getElementById('chat-history');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            if (role === 'assistant') {
                messageDiv.innerHTML = `<div class="message-header">
                    <i class="fas fa-robot"></i> ck的小助理
                </div>
                <div class="message-content">${content}</div>`;
            } else {
                messageDiv.innerHTML = `<div class="message-header">
                    <i class="fas fa-user"></i> 您
                </div>
                <div class="message-content">${content}</div>`;
            }
            
            historyDiv.appendChild(messageDiv);
            historyDiv.scrollTop = historyDiv.scrollHeight;
            return messageDiv.querySelector('.message-content');
        }
        
        function clearAssistantResponse() {
            const historyDiv = document.getElementById('chat-history');
            const lastMessage = historyDiv.lastChild;
            if (lastMessage && lastMessage.classList.contains('assistant')) {
                lastMessage.remove();
            }
        }
        
        function updateProcessStep(message) {
            // 重置所有步骤
            resetProcessSteps();
            
            // 根据消息更新对应步骤
            if (message.includes('分析用户输入')) {
                document.getElementById('step-input').classList.add('active');
            } else if (message.includes('查询知识库')) {
                document.getElementById('step-input').classList.add('completed');
                document.getElementById('step-query').classList.add('active');
            } else if (message.includes('生成回答')) {
                document.getElementById('step-input').classList.add('completed');
                document.getElementById('step-query').classList.add('completed');
                document.getElementById('step-generate').classList.add('active');
            } else if (message.includes('更新知识库')) {
                document.getElementById('step-input').classList.add('completed');
                document.getElementById('step-query').classList.add('completed');
                document.getElementById('step-generate').classList.add('completed');
                document.getElementById('step-update').classList.add('active');
            } else if (message.includes('执行自我反思')) {
                document.getElementById('step-input').classList.add('completed');
                document.getElementById('step-query').classList.add('completed');
                document.getElementById('step-generate').classList.add('completed');
                document.getElementById('step-update').classList.add('completed');
                document.getElementById('step-reflect').classList.add('active');
            }
        }
        
        function resetProcessSteps() {
            const steps = document.querySelectorAll('.process-step');
            steps.forEach(step => {
                step.classList.remove('active', 'completed');
            });
        }
        
        // 知识库管理功能
        let kbFiles = {};
        
        function openKBEditor() {
            document.getElementById('kb-modal').style.display = 'block';
            refreshKBContent();
        }
        
        function closeKBEditor() {
            document.getElementById('kb-modal').style.display = 'none';
        }
        
        function refreshKBContent() {
            // 从后端重新加载知识库内容
            fetch('/get_knowledge_base')
                .then(response => response.json())
                .then(data => {
                    kbFiles = data.files;
                    renderKBFiles();
                })
                .catch(error => {
                    console.error('刷新知识库内容失败:', error);
                    alert('刷新失败: ' + error.message);
                });
        }
        
        function renderKBFiles() {
            const container = document.getElementById('kb-files-container');
            container.innerHTML = '';
            
            for (const [filename, content] of Object.entries(kbFiles)) {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'kb-file';
                
                const header = document.createElement('div');
                header.className = 'kb-file-header';
                header.innerHTML = `
                    <span class="filename">${filename}</span>
                    <button class="delete-file-btn" data-filename="${filename}"><i class="fas fa-trash"></i> 删除</button>
                `;
                
                const textarea = document.createElement('textarea');
                textarea.className = 'kb-file-content';
                textarea.value = content;
                textarea.dataset.filename = filename;
                
                fileDiv.appendChild(header);
                fileDiv.appendChild(textarea);
                container.appendChild(fileDiv);
            }
            
            // 添加删除文件事件监听器
            document.querySelectorAll('.delete-file-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filename = this.dataset.filename;
                    if (confirm(`确定要删除文件 "${filename}" 吗？`)) {
                        // 发送删除请求到后端
                        fetch('/delete_knowledge_file', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({filename: filename})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 从前端删除文件
                                delete kbFiles[filename];
                                renderKBFiles();
                                alert('文件已删除');
                            } else {
                                alert('删除失败: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('删除文件失败:', error);
                            alert('删除失败: ' + error.message);
                        });
                    }
                });
            });
        }
        
        function saveKBContent() {
            // 收集所有文件内容
            const filesContent = {};
            document.querySelectorAll('.kb-file-content').forEach(textarea => {
                filesContent[textarea.dataset.filename] = textarea.value;
            });
            
            // 添加新文件（如果有）
            for (const [filename, content] of Object.entries(kbFiles)) {
                if (!(filename in filesContent)) {
                    filesContent[filename] = content;
                }
            }
            
            fetch('/save_knowledge_base', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({files: filesContent})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('知识库内容已保存');
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('保存知识库内容失败:', error);
                alert('保存失败: ' + error.message);
            });
        }
        
        // 添加新文件夹
        document.getElementById('add-folder-btn').addEventListener('click', function() {
            const folderPath = prompt('请输入新文件夹路径：', 'new_folder');
            if (folderPath) {
                // 创建文件夹
                fetch('/create_knowledge_folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({folder_path: folderPath})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('文件夹已创建');
                        refreshKBContent();
                    } else {
                        alert('创建失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('创建文件夹失败:', error);
                    alert('创建失败: ' + error.message);
                });
            }
        });
        
        // 显示知识库结构
        document.getElementById('show-structure-btn').addEventListener('click', function() {
            // 隐藏文件容器，显示结构容器
            document.getElementById('kb-files-container').style.display = 'none';
            document.getElementById('kb-structure-container').style.display = 'block';
            
            // 获取并显示知识库结构
            fetch('/get_knowledge_base_structure')
                .then(response => response.json())
                .then(data => {
                    if (data.structure) {
                        renderKBStructure(data.structure);
                    } else {
                        document.getElementById('kb-structure-content').innerHTML = '<p>无法获取知识库结构</p>';
                    }
                })
                .catch(error => {
                    console.error('获取知识库结构失败:', error);
                    document.getElementById('kb-structure-content').innerHTML = '<p>获取知识库结构失败: ' + error.message + '</p>';
                });
        });
        
        // 返回文件视图
        document.getElementById('back-to-files-btn').addEventListener('click', function() {
            // 隐藏结构容器，显示文件容器
            document.getElementById('kb-structure-container').style.display = 'none';
            document.getElementById('kb-files-container').style.display = 'block';
        });
        
        // 渲染知识库结构
        function renderKBStructure(structure) {
            const container = document.getElementById('kb-structure-content');
            container.innerHTML = '';
            
            function renderNode(node, level = 0) {
                const indent = '&nbsp;'.repeat(level * 4);
                const nodeDiv = document.createElement('div');
                nodeDiv.style.marginLeft = level > 0 ? '20px' : '0';
                
                if (node.type === 'folder') {
                    nodeDiv.innerHTML = `${indent}<i class="fas fa-folder" style="color: #f59e0b;"></i> ${node.name}`;
                    container.appendChild(nodeDiv);
                    
                    // 渲染子节点
                    if (node.children) {
                        for (const [name, child] of Object.entries(node.children)) {
                            renderNode(child, level + 1);
                        }
                    }
                } else {
                    nodeDiv.innerHTML = `${indent}<i class="fas fa-file-alt" style="color: #6366f1;"></i> ${node.name}`;
                    container.appendChild(nodeDiv);
                }
            }
            
            // 渲染根节点
            for (const [name, node] of Object.entries(structure)) {
                renderNode(node, 0);
            }
        }
        
        // 一键整理知识库
        document.getElementById('organize-kb-btn').addEventListener('click', function() {
            if (confirm('确定要智能整理知识库吗？系统将自动分析并优化文件结构。')) {
                // 显示处理状态
                document.getElementById('processing-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> 整理中...';
                document.getElementById('processing-status').className = 'status-indicator processing';
                
                // 发送整理请求
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/organize_knowledge_base', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                // 处理服务器发送的事件
                xhr.onprogress = function() {
                    const lines = xhr.responseText.split('\n\n');
                    for (let line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                handleStreamData(data);
                            } catch (e) {
                                // 忽略解析错误
                            }
                        }
                    }
                };
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        // 重置处理状态
                        document.getElementById('processing-status').innerHTML = '<i class="fas fa-clock"></i> 空闲中';
                        document.getElementById('processing-status').className = 'status-indicator';
                        
                        if (xhr.status !== 200) {
                            alert('整理失败，状态码: ' + xhr.status);
                        } else {
                            // 处理最后一部分数据
                            const lines = xhr.responseText.split('\n\n');
                            for (let line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.substring(6));
                                        handleStreamData(data);
                                    } catch (e) {
                                        // 忽略解析错误
                                    }
                                }
                            }
                            refreshKBContent();
                        }
                    }
                };
                
                xhr.send(JSON.stringify({}));
            }
        });
    </script>
</body>
</html>